<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 BLE · Text Protocol (LED + Soil)</title>
  <style>
    :root{--bg:#0b0f1a;--card:#121826;--muted:#9aa4b2;--text:#e6e9ef;--pri:#60a5fa;--ok:#34d399}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(160deg,#0b0f1a 0%,#0e1430 100%);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center}
    .wrap{width:min(860px,94vw);padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:1.1rem;margin:0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:.9rem}
    .dot{width:8px;height:8px;border-radius:50%;background:#e11d48}
    .dot.on{background:#10b981}
    button{appearance:none;border:1px solid rgba(255,255,255,.12);background:#101526;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    button.primary{background:linear-gradient(180deg,rgba(96,165,250,.18),rgba(96,165,250,.05));border-color:rgba(96,165,250,.35)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{background:radial-gradient(1200px 400px at -5% -30%,rgba(96,165,250,.12),transparent),radial-gradient(800px 300px at 110% 120%,rgba(16,185,129,.10),transparent),var(--card);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .sub{color:var(--muted);font-size:.9rem;margin:.1rem 0 .6rem}
    .valueRow{display:flex;gap:12px;align-items:baseline;flex-wrap:wrap}
    .kv{display:flex;gap:6px;align-items:baseline}
    .k{color:var(--muted);font-size:.9rem}
    .v{font-size:1.6rem;font-weight:800}
    .tiny{font-size:.85rem;color:var(--muted)}
    .switch{position:relative;width:54px;height:30px}
    .switch input{display:none}
    .slider{position:absolute;inset:0;background:#262a36;border-radius:999px;border:1px solid rgba(255,255,255,.12);transition:.18s}
    .slider:before{content:"";position:absolute;height:22px;width:22px;left:4px;top:3px;background:#e5e7eb;border-radius:50%;transition:.18s}
    .switch input:checked + .slider{background:linear-gradient(180deg,rgba(16,185,129,.22),rgba(16,185,129,.08));border-color:rgba(16,185,129,.45)}
    .switch input:checked + .slider:before{transform:translateX(24px);background:#fff}
    .hint{color:var(--muted);font-size:.82rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ESP32 BLE (LED + Soil)</h1>
      <div class="row">
        <span class="chip"><span id="dot" class="dot"></span><span id="devLabel">Disconnected</span></span>
        <button id="btnConnect" class="primary">Connect</button>
        <button id="btnDisconnect" disabled>Disconnect</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="sub">Soil Moisture (text payload: "raw,humidity")</div>
        <div class="valueRow">
          <div class="kv"><span class="k">Raw</span><span class="v" id="soilRaw">--</span></div>
          <div class="kv"><span class="k">Soil Moisture</span><span class="v" id="soilHum">--</span><span>%</span></div>
        </div>
        <div class="tiny" id="soilTime">Last update: —</div>
        <div class="row" style="margin-top:10px">
          <button id="btnRead" class="primary">Read Now</button>
          <label class="row hint" style="gap:8px;margin-left:6px">
            <span>Auto</span>
            <label class="switch"><input id="autoToggle" type="checkbox"><span class="slider"></span></label>
          </label>
        </div>
      </div>

      <div class="card">
        <div class="sub">LED</div>
        <div class="row" style="justify-content:space-between">
          <div class="hint">Sends "1" / "0" and reads back</div>
          <label class="switch"><input id="ledToggle" type="checkbox"><span class="slider"></span></label>
        </div>
        <div class="tiny" id="ledStatus" style="margin-top:8px">LED: —</div>
      </div>
    </div>

    <p class="hint" style="margin-top:14px">Note: Use Bluefy/WebBLE on iOS. The sensor characteristic must send text like <code>"1234,45"</code>.</p>
  </div>

<script>
// ===== Fixed UUIDs (text protocol) =====
const SERVICE_UUID = '19b10000-e8f2-537e-4f6c-d104768a1214';
const LED_CHAR_UUID = '19b10002-e8f2-537e-4f6c-d104768a1214';
const SENSOR_CHAR_UUID = '19b10001-e8f2-537e-4f6c-d104768a1214';

// ===== State =====
let device, server, service, ledChar, sensorChar, autoTimer=null;
const $ = s=>document.querySelector(s);
const dot=$('#dot'), devLabel=$('#devLabel');
const btnConnect=$('#btnConnect'), btnDisconnect=$('#btnDisconnect');
const btnRead=$('#btnRead'), autoToggle=$('#autoToggle');
const ledToggle=$('#ledToggle'), ledStatus=$('#ledStatus');
const soilRaw=$('#soilRaw'), soilHum=$('#soilHum'), soilTime=$('#soilTime');

function setConnected(on,name='Disconnected'){
  dot.classList.toggle('on', on);
  devLabel.textContent = on ? (name||'(no name)') : 'Disconnected';
  btnDisconnect.disabled = !on;
  btnRead.disabled = !on;
  autoToggle.disabled = !on;
  ledToggle.disabled = !on;
}

btnConnect.addEventListener('click', async()=>{
  try{
    if(!navigator.bluetooth){ alert('Web Bluetooth not available in this browser.'); return; }
    device = await navigator.bluetooth.requestDevice({
      filters:[{services:[SERVICE_UUID]}],
      optionalServices:[SERVICE_UUID]
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);
    server = await device.gatt.connect();
    service = await server.getPrimaryService(SERVICE_UUID);
    ledChar = await service.getCharacteristic(LED_CHAR_UUID);
    sensorChar = await service.getCharacteristic(SENSOR_CHAR_UUID);

    setConnected(true, device.name);

    await refreshLedFromRead();

    if (sensorChar.properties.notify) {
      autoToggle.checked = true;
      await startNotify();
    }
  }catch(e){ console.error(e); alert('Connect failed: '+e); }
});

btnDisconnect.addEventListener('click', ()=>{ try{ server && server.disconnect(); }catch{} });
function onDisconnected(){ setConnected(false); stopAuto(); }

// ===== LED: send "1" / "0" only =====
ledToggle.addEventListener('change', async()=>{
  if(!ledChar) return;
  const txt = ledToggle.checked ? '1' : '0';
  try{
    await ledChar.writeValue(new TextEncoder().encode(txt));
    await refreshLedFromRead();
  }catch(e){ console.error(e); alert('LED write failed: '+e); }
});

async function refreshLedFromRead(){
  try{
    const dv = await ledChar.readValue();
    const s = new TextDecoder().decode(dv).trim();
    const isOn = (s === '1');
    ledToggle.checked = isOn;
    ledStatus.textContent = 'LED: ' + (s || '—');
  }catch(e){ console.error(e); }
}

// ===== Sensor =====
btnRead.addEventListener('click', readSensorOnce);
autoToggle.addEventListener('change', async()=>{
  if(!sensorChar){ autoToggle.checked=false; return; }
  if(autoToggle.checked){
    if(sensorChar.properties.notify) await startNotify(); else startPolling();
  } else { stopAuto(); }
});

async function readSensorOnce(){
  try{
    const dv = await sensorChar.readValue();
    renderSensor(dv);
  }catch(e){ console.error(e); }
}

async function startNotify(){
  stopPolling();
  try{
    await sensorChar.startNotifications();
    sensorChar.addEventListener('characteristicvaluechanged', e=>renderSensor(e.target.value));
  }catch(e){ console.error(e); }
}

function startPolling(){ stopPolling(); autoTimer = setInterval(readSensorOnce, 1000); }
function stopPolling(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }
function stopAuto(){ stopPolling(); try{ sensorChar && sensorChar.stopNotifications && sensorChar.stopNotifications(); }catch{} }

function renderSensor(dv){
  const txt = new TextDecoder().decode(dv).trim();
  // Expecting "raw,humidity" (e.g., "1234,45"). Fallbacks included.
  let raw='—', hum='—';
  if (txt) {
    const parts = txt.split(/[\s,]+/).filter(Boolean);
    if (parts.length >= 2) { raw = parts[0]; hum = parts[1]; }
    else if (parts.length === 1) { raw = parts[0]; }
  }
  soilRaw.textContent = raw;
  soilHum.textContent = hum;
  soilTime.textContent = 'Last update: ' + new Date().toLocaleString();
}
</script>
</body>
</html>
